# apache 설정 파일 이슈

- ~/apache/~/httpd-ssl.conf 파일은 아파치 웹서버 설정 파일이다.
- 아파치 설정 파일 변경 중 이슈를 발견해서 기록해둔다. 

<br>

## VirtualHost

```xml
<VirtualHost *:443>
    ServerName www.example.com
    SSLEngine on
    SSLCertificateFile    "/cert.pem"
    SSLCertificateKeyFile "/key.pem"
    SSLCertificateChainFile "/CA.pem"
</VirtualHost>
```

- virtualhost 태그에 위와 같이 어떤 포트, 서버네임으로 들어오는지 적는다.
- ssl 관련 옵션은 https 접근일 때 적어준다.
- 443 포트는 https 전용 포트이다.

<br>

## 문제

- 해당 파일에서 VirtualHost 태그는 8443(웹소켓), 80(http), 443(https) 포트로 사용 중이었는데 443 포트는 https 요청이기 때문에 무조건  SSLEngine on을 적고 아래 3개 ssl 관련 파일을 연결해줘야함
- 근데 443에는 만료된 인증서가 있었고, 8443에는 현재 홈페이지에서 사용하고 있는 유효한 인증서가 적용되어있었다. 근데 어떻게 https로 홈페이지에 접근할 수 있는거지?


### 참고

- SSLCertificateFile : 서버 인증서 파일(공개)
- SSLCertificateKeyFile : 서버 개인키 파일(개인)
- SSLCertificateChainFile : 중간 인증서 체인 파일(공개)

<br>

## 분석

- 80 VirtualHost 태그, 8443 VirtualHost, 443 VirtualHost 태그 순으로 선언되어있다.
- 8443는 유효한 인증서, 443은 만료된 인증서 
- 둘의 ServerName이 같다. 
- 동일한 ServerName 사용으로 인한 인해 8443 인증서가 사용되는건가?

<br>

## 분석 결과

- 아파치에 443 https 요청을 하면 SNI=https://www.example.com
- 443 태그를 찾아들어가고 
> - 태그에 유효한 cert 있음 → 그 cert 사용
> - 태그에 만료된 cert 만료 → 같은 도메인 www.example.com 이 다른 포트(8443)에 있네?
> > - → 내부 SSL_CTX 공유 때문에 그 인증서 사용

<br>

## SSL_CTX

- ssl_ctx 공유는 일반적으로 SSL 세션 캐싱을 통해 발생합니다. SSL_CTX는 미리 생성된 SSL/TLS 설정을 담고 있어, 새로운 SSL/TLS 연결이 생성될 때 초기화하는 데 사용되며, 이 SSL_CTX를 공유함으로써 불필요한 초기화 과정을 줄여 성능을 향상시킬 수 있습니다. 

### SSL_CTX의 역할 및 공유 이유 

- SSL/TLS 설정 관리: SSL_CTX는 SSL/TLS 연결에 필요한 다양한 설정(인증서, 개인 키, 프로토콜 버전 등)을 가지고 있는 구조체입니다.
- 성능 향상: 모든 SSL/TLS 연결마다 SSL_CTX를 새로 생성하고 초기화하는 것은 비용이 많이 드는 작업입니다. 이를 공유하면 재사용 가능한 세션 정보를 캐싱하여, 새로운 연결을 맺을 때 초기화 시간을 줄이고 전반적인 성능을 향상시킬 수 있습니다.


<br>

## 해결
- 443 VirtualHost 태그에도 ssl 유효한 설정파일을 넣어주자
- 변수 처럼 사용

```xml
Define CERT_FILE "/cert.pem"
Define CERT_KEY "/key.pem"
Define CERT_CHAIN "/CA.pem"

<VirtualHost *:443>
    ServerName www.example.com
    SSLEngine on
    SSLCertificateFile    ${CERT_FILE}
    SSLCertificateKeyFile ${CERT_KEY}
    SSLCertificateChainFile ${CERT_CHAIN}
</VirtualHost>

<VirtualHost *:8443>
    ServerName www.example.com
    SSLEngine on
    SSLCertificateFile    ${CERT_FILE}
    SSLCertificateKeyFile ${CERT_KEY}
    SSLCertificateChainFile ${CERT_CHAIN}
</VirtualHost>
```

<br>

- Include 호출로 불러오기
- ssl-common.conf 파일

```xml
SSLCertificateFile    "/cert.pem"
SSLCertificateKeyFile "/key.pem"
SSLCertificateChainFile "/CA.pem"
```

```xml
<VirtualHost *:443>
    ServerName www.example.com
    SSLEngine on
    Include /ssl-common.conf
</VirtualHost>

<VirtualHost *:8443>
    ServerName www.example.com
    SSLEngine on
    Include /ssl-common.conf
</VirtualHost>
```

- 후자가 관리할 때 좋아보인다.